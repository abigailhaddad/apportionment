---
title: "September Unobligated Spending Analysis"
format: 
  html:
    theme: cosmo
    toc: true
---

```{python}
#| include: false
import pandas as pd
import numpy as np
import scipy.stats as stats
from statsmodels.stats.multitest import fdrcorrection
import plotly.express as px

def clean_monetary_value(value):
    """Convert monetary string like '$98,688.5M' to float in millions"""
    if pd.isna(value) or value == '$0.0M':
        return 0.0
    cleaned = str(value).replace('$', '').replace('M', '').replace(',', '')
    try:
        return float(cleaned)
    except:
        return 0.0

def analyze_september_years():
    """Analyze September data 2018-2025 with proper filtering"""
    import glob
    
    sep_files = glob.glob('site/data/*Sep*.csv')
    sep_files.sort()
    
    yearly_data = []
    
    for file_path in sep_files:
        year = int(file_path.split('_')[-2])
        df = pd.read_csv(file_path)
        
        # Filter to accounts expiring in that year (like website does)
        df_filtered = df[df['Expiration_Year'] == str(year)].copy()
        
        # Clean monetary columns
        df_filtered['Unobligated_Balance_Clean'] = df_filtered['Unobligated Balance (Line 2490)'].apply(clean_monetary_value)
        df_filtered['Budget_Authority_Clean'] = df_filtered['Budget Authority (Line 2500)'].apply(clean_monetary_value)
        
        # Calculate totals
        total_unobligated = df_filtered['Unobligated_Balance_Clean'].sum()
        total_budget_authority = df_filtered['Budget_Authority_Clean'].sum()
        
        if total_budget_authority > 0:
            percent_unobligated = (total_unobligated / total_budget_authority) * 100
        else:
            percent_unobligated = 0
        
        yearly_data.append({
            'year': year,
            'percent_unobligated': percent_unobligated
        })
    
    return pd.DataFrame(yearly_data)

def get_outliers_and_notable(df_2025, level_name, groupby_cols, min_budget):
    """Get outliers and entities with high unobligated spending at a specific level"""
    
    # Build aggregation
    agg_dict = {
        'Unobligated_Balance_Clean': 'sum',
        'Budget_Authority_Clean': 'sum'
    }
    if 'Account' not in groupby_cols:
        agg_dict['Account'] = 'count'
    
    summary = df_2025.groupby(groupby_cols).agg(agg_dict).reset_index()
    
    # Calculate percentage
    summary['Percent_Unobligated'] = np.where(
        summary['Budget_Authority_Clean'] > 0,
        (summary['Unobligated_Balance_Clean'] / summary['Budget_Authority_Clean']) * 100,
        0
    )
    
    # Filter by budget
    summary = summary[summary['Budget_Authority_Clean'] >= min_budget].copy()
    
    if len(summary) == 0:
        return pd.DataFrame(), pd.DataFrame()
    
    # Calculate statistics for outlier detection first
    mean_pct = summary['Percent_Unobligated'].mean()
    std_pct = summary['Percent_Unobligated'].std()
    
    if std_pct == 0:
        return summary.head(5), summary.head(10)  # Just return top if no variation
    
    # Calculate z-scores and p-values
    summary['Z_Score'] = (summary['Percent_Unobligated'] - mean_pct) / std_pct
    summary['P_Value'] = 2 * (1 - stats.norm.cdf(np.abs(summary['Z_Score'])))
    
    # FDR correction
    reject, p_corrected = fdrcorrection(summary['P_Value'], alpha=0.05)
    summary['Is_Outlier'] = reject
    
    # Create entity name
    summary['Entity'] = summary[groupby_cols].apply(lambda x: ' | '.join(x.astype(str)), axis=1)
    
    # Sort by percentage descending
    summary = summary.sort_values('Percent_Unobligated', ascending=False)
    
    # Get outliers first - filter out negative z-scores
    outliers = summary[summary['Is_Outlier'] & (summary['Z_Score'] > 0)].copy()
    
    # For non-outliers, also filter out negative z-scores
    non_outliers = summary[~summary['Is_Outlier'] & (summary['Z_Score'] > 0)].copy()
    
    # Only calculate historical data for entities we'll actually display
    def get_historical_data(entity_cols, entity_values):
        import glob
        sep_files = glob.glob('site/data/*Sep*.csv')
        historical_pcts = []
        
        for file_path in sep_files:
            year = int(file_path.split('_')[-2])
            if year >= 2018 and year <= 2024:  # Only historical years
                df_hist = pd.read_csv(file_path)
                df_hist_filtered = df_hist[df_hist['Expiration_Year'] == str(year)].copy()
                
                # Clean monetary columns
                df_hist_filtered['Unobligated_Balance_Clean'] = df_hist_filtered['Unobligated Balance (Line 2490)'].apply(clean_monetary_value)
                df_hist_filtered['Budget_Authority_Clean'] = df_hist_filtered['Budget Authority (Line 2500)'].apply(clean_monetary_value)
                
                # Filter to this specific entity
                entity_filter = True
                for col, val in zip(entity_cols, entity_values):
                    entity_filter = entity_filter & (df_hist_filtered[col] == val)
                
                entity_data = df_hist_filtered[entity_filter]
                
                if len(entity_data) > 0:
                    total_unobligated = entity_data['Unobligated_Balance_Clean'].sum()
                    total_budget = entity_data['Budget_Authority_Clean'].sum()
                    if total_budget > 0:
                        pct = (total_unobligated / total_budget) * 100
                        # Debug: ensure we're getting positive percentages
                        if pct >= 0:
                            historical_pcts.append(pct)
        
        if len(historical_pcts) > 0:
            # Mark with asterisk if we're missing some years (should have 7 years: 2018-2024)
            missing_years = len(historical_pcts) < 7
            avg_val = np.mean(historical_pcts)
            max_val = max(historical_pcts)
            return avg_val, max_val, missing_years
        else:
            return None, None, False
    
    def add_historical_data(df):
        if len(df) == 0:
            return df
            
        historical_avgs = []
        historical_highs = []
        missing_years_flags = []
        
        for _, row in df.iterrows():
            entity_values = [row[col] for col in groupby_cols]
            avg_hist, max_hist, missing_years = get_historical_data(groupby_cols, entity_values)
            historical_avgs.append(avg_hist)
            historical_highs.append(max_hist)
            missing_years_flags.append(missing_years)
        
        df = df.copy()
        df['Historical_Avg'] = historical_avgs
        df['Historical_High'] = historical_highs
        df['Missing_Years'] = missing_years_flags
        return df
    
    # Add historical data to outliers
    outliers = add_historical_data(outliers)
    
    # Only calculate historical data for top 15 non-outliers, then filter
    top_candidates = non_outliers.head(15)
    candidates_with_hist = add_historical_data(top_candidates)
    
    # Filter to only show entities that are above their historical average (or have no historical data)
    if len(candidates_with_hist) > 0:
        above_avg = candidates_with_hist[
            (candidates_with_hist['Historical_Avg'].isna()) |
            (candidates_with_hist['Percent_Unobligated'] > candidates_with_hist['Historical_Avg'])
        ]
        notable = above_avg.head(10)
    else:
        notable = pd.DataFrame()
    
    # Format for display
    def format_results(df):
        if len(df) == 0:
            return pd.DataFrame()
        
        result = df[['Entity', 'Percent_Unobligated', 'Historical_Avg', 'Historical_High', 'Missing_Years', 'Budget_Authority_Clean', 'Z_Score']].copy()
        result['Budget_Billions'] = result['Budget_Authority_Clean'] / 1000
        result['Percent_Unobligated'] = result['Percent_Unobligated'].round(1)
        
        # Handle historical averages with asterisks for missing years
        result['Historical_Avg_Display'] = result.apply(lambda row: 
            'N/A' if pd.isna(row['Historical_Avg']) 
            else f"{row['Historical_Avg']:.1f}*" if row['Missing_Years'] 
            else f"{row['Historical_Avg']:.1f}", axis=1)
        
        result['Historical_High_Display'] = result.apply(lambda row: 
            'N/A' if pd.isna(row['Historical_High']) 
            else f"{row['Historical_High']:.1f}*" if row['Missing_Years'] 
            else f"{row['Historical_High']:.1f}", axis=1)
        
        result['Z_Score'] = result['Z_Score'].round(2)
        result['Budget_Billions'] = result['Budget_Billions'].round(1)
        
        result = result.rename(columns={
            'Entity': level_name,
            'Percent_Unobligated': '% Unobligated 2025',
            'Historical_Avg_Display': '2018-2024 Avg (%)',
            'Historical_High_Display': 'Previous High (%)',
            'Budget_Billions': 'Budget ($B)',
            'Z_Score': 'Z-Score'
        })
        
        # Set pandas display options for full column width
        pd.set_option('display.max_colwidth', None)
        pd.set_option('display.width', None)
        pd.set_option('display.max_columns', None)
        
        # Set the entity name as index to remove index numbers
        result = result.set_index(level_name)
        
        return result[['% Unobligated 2025', '2018-2024 Avg (%)', 'Previous High (%)', 'Budget ($B)', 'Z-Score']]
    
    return format_results(outliers), format_results(notable)

# Load and analyze data
years_df = analyze_september_years()

# Calculate historical context
historical_2018_2024 = years_df[years_df['year'] <= 2024]['percent_unobligated']
historical_data = {
    'avg_2018_2024': historical_2018_2024.mean(),
    'previous_high': historical_2018_2024.max()
}

# Read 2025 data for outlier analysis
df_2025 = pd.read_csv('site/data/all_agencies_monthly_summary_2025_Sep.csv')
df_2025_filtered = df_2025[df_2025['Expiration_Year'] == '2025'].copy()

# Clean monetary columns
df_2025_filtered['Unobligated_Balance_Clean'] = df_2025_filtered['Unobligated Balance (Line 2490)'].apply(clean_monetary_value)
df_2025_filtered['Budget_Authority_Clean'] = df_2025_filtered['Budget Authority (Line 2500)'].apply(clean_monetary_value)

# Get outlier analysis for all levels
agency_outliers, agency_notable = get_outliers_and_notable(df_2025_filtered, 'Agency', ['Agency'], 100)
bureau_outliers, bureau_notable = get_outliers_and_notable(df_2025_filtered, 'Bureau', ['Agency', 'Bureau'], 50)
account_outliers, account_notable = get_outliers_and_notable(df_2025_filtered, 'Account', ['Agency', 'Bureau', 'Account'], 10)
```

## Year-over-Year Analysis (2018-2025)

September data for accounts expiring in each respective year.

```{python}
# Create scatterplot
fig = px.scatter(years_df, 
                x='year', 
                y='percent_unobligated',
                title='Percent Unobligated by Year (September Data)',
                labels={'year': 'Year', 'percent_unobligated': 'Percent Unobligated'})

fig.show()
```

## 2025 Outlier Analysis

```{python}
print(f"Historical Context:")
print(f"• 2018-2024 Average: {historical_data['avg_2018_2024']:.1f}% unobligated")
print(f"• Previous High: {historical_data['previous_high']:.1f}% unobligated")
print(f"• 2025: {years_df[years_df['year'] == 2025]['percent_unobligated'].iloc[0]:.1f}% unobligated")
print(f"\nNote: * indicates historical averages based on fewer than 7 years of data")
print(f"N/A indicates this entity was not found in historical data (new or renamed entity)")
```

### Agency Level

**Outliers:**

```{python}
if len(agency_outliers) > 0:
    print("Agencies with Outlier High Unobligated Spending:")
    display(agency_outliers)
else:
    print("No outliers at agency level")
```

**Higher Than Average (not outliers):**

```{python}
if len(agency_notable) > 0:
    print("Agencies Higher Than Average but Not Outliers:")
    display(agency_notable)
else:
    print("No agencies higher than average")
```

### Bureau Level

**Outliers:**

```{python}
if len(bureau_outliers) > 0:
    print("Bureaus with Outlier High Unobligated Spending:")
    display(bureau_outliers)
else:
    print("No outliers at bureau level")
```

**Higher Than Average (not outliers):**

```{python}
if len(bureau_notable) > 0:
    print("Bureaus Higher Than Average but Not Outliers:")
    display(bureau_notable)
else:
    print("No bureaus higher than average")
```

### Account Level

**Outliers:**

```{python}
if len(account_outliers) > 0:
    print("Accounts with Outlier High Unobligated Spending:")
    display(account_outliers)
else:
    print("No outliers at account level")
```

**Higher Than Average (not outliers):**

```{python}
if len(account_notable) > 0:
    print("Accounts Higher Than Average but Not Outliers:")
    display(account_notable)
else:
    print("No accounts higher than average")

```